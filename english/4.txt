
4 MAC Message Formats
All LoRa uplink and downlink messages carry a PHY payload (Payload) starting with a single-octet MAC header (MHDR), followed by a MAC payload (MACPayload), and ending with a 4-octet message integrity code (MIC).
Radio PHY layer:

1 Maximum payload size is detailed in the Chapter 6.
2 For Join-Accept frame, the MIC field is encrypted with the payload and is not a separate field


4.1 MAC Layer (PHYPayload)
The maximum length (M) of the MACPayload field is region specific and is specified in Chapter 6.

4.2 MAC Header (MHDR field)
The MAC header specifies the message type (MType) and according to which major version (Major) of the frame format of the LoRaWAN layer specification the frame has been encoded.

4.2.1 Message type (MType bit field)
The LoRaWAN distinguishes between 8 different MAC message types: Join-request, Rejoin-request, Join-accept, unconfirmed data up/down, and confirmed data up/down and proprietary protocol messages.

4.2.1.1 Join-request and join-accept messages
The join-request, Rejoin-request and join-accept messages are used by the over-the-air activation procedure described in Chapter 6.2 and for roaming purposes.


4.2.1.2 Data messages
Data messages are used to transfer both MAC commands and application data, which can be combined together in a single message. A confirmed-data message MUST be acknowledged by the receiver, whereas an unconfirmed-data message does not require an acknowledgment. Proprietary messages can be used to implement non-standard message formats that are not interoperable with standard messages but must only be used among devices that have a common understanding of the proprietary extensions. When an end-device or a Network Server receives an unknown proprietary message, it SHALL silently drop it.

Message integrity is ensured in different ways for different message types and is described per message type below.


1 A detailed timing diagram of the acknowledge mechanism is given in Section 19.

4.2.2 Major version of data message (Major bit field)

Note: The Major version specifies the format of the messages exchanged in the join procedure (see Chapter 6.2) and the first four bytes of the MAC Payload as described in Chapter 4. For each major version, end-devices may implement different minor versions of the frame format. The minor version used by an end-device must be made known to the Network Server beforehand using out of band messages (e.g., as part of the device personalization information). When a device or a Network Server receives a frame carrying an unknown or unsupported version of LoRaWAN, it SHALL silently drop it.

4.3 MAC Payload of Data Messages (MACPayload)

The MAC payload of the data messages, contains a frame header (FHDR) followed by an optional port field (FPort) and an optional frame payload field (FRMPayload).

A frame with a valid FHDR, no Fopts (FoptsLen = 0), no Fport and no FRMPayload is a valid frame.

4.3.1 Frame header (FHDR)

The FHDR contains the short device address of the end-device (DevAddr), a frame control octet (FCtrl), a 2-octets frame counter (FCnt), and up to 15 octets of frame options (FOpts) used to transport MAC commands. If present, the FOpts field shall be encrypted using the NwkSEncKey as described in section 4.3.1.6.

For downlink frames the FCtrl content of the frame header is:

4.3.1.1 Adaptive data rate control in frame header (ADR, ADRACKReq in FCtrl)

LoRa network allows the end-devices to individually use any of the possible data rates and Tx power. This feature is used by the LoRaWAN to adapt and optimize the data rate and Tx power of static end-devices. This is referred to as Adaptive Data Rate (ADR) and when this is enabled the network will be optimized to use the fastest data rate possible.

Adaptive Data Rate control may not be possible when the radio channel attenuation changes fast and constantly. When the Network Server is unable to control the data rate of a device, the deviceâ€™s application layer should control it. It is recommended to use a variety of different data rates in this case. The application layer SHOULD always try to minimize the aggregated air time used given the network conditions.

If the uplink ADR bit is set, the network will control the data rate and Tx power of the end-device through the appropriate MAC commands. If the ADR bit is not set, the network will not attempt to control the data rate nor the transmit power of the end-device regardless of the received signal quality. The network MAY still send commands to change the Channel mask or the frame repetition parameters.

When the downlink ADR bit is set, it informs the end-device that the Network Server is in a position to send ADR commands. The device MAY set/unset the uplink ADR bit.

When the downlink ADR bit is unset, it signals the end-device that due to rapid changes of the radio channel, the network temporarily cannot estimate the best data rate. In that case the device has the choice to either

? unset the ADR uplink bit, and control its uplink data rate following its own strategy. This SHOULD be the typical strategy for a mobile end-device.
? Ignore it (keep the uplink ADR bit set) and apply the normal data rate decay in the absence of ADR downlink commands. This SHOULD be the typical strategy for a stationary end-device.

The ADR bit may be set and unset by the end-device or the Network on demand. However, whenever possible, the ADR scheme SHOULD be enabled to increase the battery life of the end-device and maximize the network capacity.

Note: Even mobile end-devices are actually immobile most of the time. So depending on its state of mobility, an end-device can request the network to optimize its data rate using the ADR uplink bit.

Default Tx Power is the maximum transmission power allowed for the device considering device capabilities and regional regulatory constraints. Device shall use this power level, until the network asks for less, through the LinkADRReq MAC command.

If an end-device’s data rate is optimized by the network to use a data rate higher than its default data rate, or a TXPower lower than its default TXPower, it periodically needs to validate that the network still receives the uplink frames. Each time the uplink frame counter is incremented (for each new uplink, repeated transmissions do not increase the counter), the device increments an ADR_ACK_CNT counter. After ADR_ACK_LIMIT uplinks(ADR_ACK_CNT >= ADR_ACK_LIMIT) without any downlink response, it sets the ADR acknowledgment request bit (ADRACKReq). The network is required to respond with a downlink frame within the next ADR_ACK_DELAY frames, any received downlink frame following an uplink frame resets the ADR_ACK_CNT counter. The downlink ACK bit does not need to be set as any response during the receive slot of the end-device indicates that the gateway has still received the uplinks from this device. If no reply is received within the next ADR_ACK_DELAY uplinks (i.e., after a total of ADR_ACK_LIMIT + ADR_ACK_DELAY), the end-device MUST try to regain connectivity by first stepping up the transmit power to default power if possible then switching to the next lower data rate that provides a longer radio range. The end-device MUST further lower its data rate step by step every time ADR_ACK_DELAY is reached. Once the device has reached the lowest data rate, it MUST re-enable all default uplink frequency channels.

The ADRACKReq SHALL not be set if the device uses its default data rate and transmit power because in that case no action can be taken to improve the link range.

Note: Not requesting an immediate response to an ADR acknowledgement request provides flexibility to the network to optimally schedule its downlinks.

Note: In uplink transmissions the ADRACKReq bit is set if ADR_ACK_CNT >= ADR_ACK_LIMIT and the current data-rate is greater than the device defined minimum data rate or its transmit power is lower than the default, or the current channel mask only uses a subset of all the default channels. It is cleared in other conditions.

The following table provides an example of data rate back-off sequence assuming ADR_ACK_LIMIT and ADR_ACK_DELAY constants are both equal to 32.

4.3.1.2 Message acknowledge bit and acknowledgement procedure (ACK in FCtrl)

When receiving a confirmed data message, the receiver SHALL respond with a data frame that has the acknowledgment bit (ACK) set. If the sender is an end-device, the network will try to send the acknowledgement using one of the receive windows opened by the end-device after the send operation. If the sender is a gateway, the end-device transmits an
acknowledgment at its own discretion (see note below).

An acknowledgement is only sent in response to the latest message received and it is never retransmitted.

Note: To allow the end-devices to be as simple as possible and have as few states as possible it may transmit an explicit (possibly empty) acknowledgement data message immediately after the reception of a data message requiring a confirmation. Alternatively the end-device may defer the transmission of an acknowledgement to piggyback it with its next data message.

4.3.1.3 Retransmission procedure
Downlink frames:
A downlink “confirmed” or “unconfirmed” frame SHALL not be retransmitted using the same frame counter value. In the case of a “confirmed” downlink, if the acknowledge is not received, the application server is notified and may decide to retransmit a new “confirmed” frame.

Uplink frames:
Uplink “confirmed” & “unconfirmed” frames are transmitted “NbTrans” times (see 5.3) except if a valid downlink is received following one of the transmissions. The “NbTrans” parameter can be used by the network manager to control the redundancy of the node uplinks to obtain a given Quality of Service. The end-device SHALL perform frequency hopping as usual
between repeated transmissions, It SHALL wait after each repetition until the receive
windows have expired. The delay between the retransmissions is at the discretion of the
end-device and MAY be different for each end-device.

The device SHALL stop any further retransmission of an uplink “confirmed” frame if a corresponding downlink acknowledgement frame is received

Class B&C devices SHALL stop any further retransmission of an uplink “unconfirmed” frame whenever a valid unicast downlink message is received during the RX1 slot window.

Class A devices SHALL stop any further retransmission of an uplink “unconfirmed” frame whenever a valid downlink message is received during the RX1 or the RX2 slot window.

If the network receives more than NbTrans transmissions of the same uplink frame, this may be an indication of a replay attack or a malfunctioning device, and therefore the network SHALL not process the extra frames.

NOTE: The network detecting a replay attack may take additional measures, such as reducing the NbTrans parameter to 1, or discarding uplink frames that are received over a channel that was already used by an earlier transmission of the same frame, or by some other unspecified mechanism

4.3.1.4 Frame pending bit (FPending in FCtrl, downlink only)

The frame pending bit (FPending) is only used in downlink communication, indicating that the network has more data pending to be sent and therefore asking the end-device to open another receive window as soon as possible by sending another uplink message. The exact use of FPending bit is described in Chapter 19.3.

4.3.1.5 Frame counter (FCnt)

Each end-device has three frame counters to keep track of the number of data frames sent uplink to the Network Server (FCntUp), and sent downlink from the Network Server to the device (FCntDown).

In the downlink direction two different frame counter scheme exists; a single counter scheme in which all ports share the same downlink frame counter FCntDown when the device operates as a LoRaWAN1.0 device, and a two-counter scheme in which a separate NFCntDown is used for MAC communication on port 0 and when the FPort field is missing, and another AFCntDown is used for all other ports when the device operates as a LoRaWAN1.1 device.

In the two counters scheme the NFCntDown is managed by the Network Server, whereas the AFCntDown is managed by the application server.

Note: LoRaWAN v1.0 and earlier support only one FCntDown counter(shared across all ports) and the Network Server must take care to support this scheme for devices prior to LoRaWAN v1.1.










