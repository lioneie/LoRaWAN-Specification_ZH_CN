
每当OTAA设备成功处理Join-accept消息时，终端设备（FCntUp）上的帧计数器和该终端设备的网络侧帧计数器（NFCntDown和AFCntDown）将重置为0。

ABP器件的帧计数器在制造时初始化为0。 在ABP设备中，帧计数器绝不能在设备的使用寿命期间复位。 如果终端设备在其使用寿命期间容易失去电力（例如更换电池），则在这种情况下帧计数器应该持续存在。

随后，FCntUp随每个上行链路递增。 NFC输出随着FPort 0上的每个下行链路递增或者当FPort字段丢失时递增。 AFCntDown随着每个下行链路在不同于0的端口上递增。在接收器侧，相应的计数器与接收的值保持同步，前提是接收的值与当前计数器值相比递增，并且消息MIC字段与MIC匹配 使用适当的网络会话密钥在本地计算的值。 在多次传输已确认或未确认的帧的情况下，FCnt不会递增（请参阅NbTrans参数）。 网络服务器应删除重新传输的帧的应用程序有效负载，并仅将单个实例转发到应用程序服务器。

帧计数器是32位宽，FCnt字段对应于32位帧计数器的最低有效16位（即，用于发送上行链路的数据帧的FCntUp和用于下行链路发送的数据帧的AFCntDown / NFCntDown）。

终端设备不应重复使用相同的FCntUp值和相同的应用程序或网络会话密钥，除了重传相同的已确认或未确认的帧。

终端设备应该永远不会处理相同下行链路帧的任何重传。 不经处理，应忽略后续重传。

注意：这意味着一旦接收到下行链路确认帧，设备将仅确认，类似地，设备将仅在接收到设置了FPending位的帧之后生成单个上行链路。

注意：由于FCnt字段仅携带32位帧计数器的最低有效16位，因此服务器必须从流量观察中推断出帧计数器的16个最高有效位。

4.3.1.6帧选项（FCtrl中的FOptsLen，FOpts）

FCtrl字节中的帧选项长度字段（FOptsLen）表示帧中包括的帧选项字段（FOpts）的实际长度。

FOpts最大长度为15个八位字节的传输MAC命令，这些命令被搭载到数据帧上; 有关有效MAC命令的列表，请参阅第5章。

如果FOptsLen为0，则不存在FOpts字段。 如果FOptsLen与0不同，即如果FOpts字段中存在MAC命令，则不能使用端口0（FPort必须不存在或不同于0）。

MAC命令不能同时出现在有效载荷字段和帧选项字段中。 如果发生这种情况，设备应该忽略该帧。

如果帧头携带FOpts，则必须在计算消息完整性代码（MIC）之前对FOpts进行加密。

所使用的加密方案基于IEEE 802.15.4 / 2006附录B [IEEE802154]中描述的通用算法，其使用密钥长度为128位的AES。

使用的密钥K是上行链路和下行链路方向上的Fwpts字段的NwkSEncKey。

加密的字段是：pld = FOpts

对于每条消息，算法定义一个块A：

方向字段（Dir）对于上行链路帧为0，对于下行链路帧为1。

块A被加密以获得块S：

S = aes128_encrypt（K，A）

通过将（pld | pad16）xor S截断到第一个len（pld）八位字节来完成FOpts的加密和解密。

4.3.1.7 B类

在上行链路中设置为1的B类比特向网络服务器发信号通知该设备切换到B类模式并且现在准备接收预定的下行链路ping。 有关B类规范，请参阅文档的B类部分。

4.3.2端口字段（FPort）

如果帧有效载荷字段不为空，则必须存在端口字段。 如果存在，则FPort值为0表示FRMPayload仅包含MAC命令，并且具有这种FPort的任何接收帧应由LoRaWAN实现处理; 有关有效MAC命令的列表，请参阅第5章。 FPort值1..223（0x01..0xDF）是特定于应用程序的，并且具有这种FPort的任何接收帧都应由LoRaWAN实现提供给应用程序层。 FPort值224专用于LoRaWAN MAC层测试协议。 LoRaWAN实现应丢弃来自FPort值不在1..224范围内的应用层的任何传输请求。